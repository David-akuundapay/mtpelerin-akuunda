<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Akuunda Pay - Crypto Exchange</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="no-referrer-when-downgrade" />
  <link rel="icon" href="https://raw.githubusercontent.com/David-akuundapay/mtpelerin-akuunda/main/mtpelerin-akuunda/images/favicon.png" type="image/png" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:url('https://raw.githubusercontent.com/David-akuundapay/mtpelerin-akuunda/main/mtpelerin-akuunda/images/Business%20Card%20-%20Front.png') no-repeat center/cover fixed;
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px
    }
    .container{width:100%;max-width:480px}
    .header{text-align:center;margin-bottom:18px}
    .hero-image{width:400px;max-width:95%;border-radius:15px;border:5px solid #fff;box-shadow:0 10px 30px rgba(57,22,89,.4);margin:0 auto 18px auto}
    .header h1{
      font-size:2.2rem; font-weight:700; margin-bottom:6px;
      background:linear-gradient(135deg,#fff 0%,#F88809 100%);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text
    }
    .header p{color:#fff;font-size:1.05rem;text-shadow:1px 1px 4px rgba(57,22,89,.6);font-weight:500}
    .service-indicator{
      background:rgba(57,22,89,.9); color:#fff; padding:10px 16px; border-radius:10px;
      margin:14px 0; text-align:center; font-weight:700; font-size:1rem; box-shadow:0 4px 12px rgba(57,22,89,.3)
    }
    .panel{background:rgba(255,255,255,.95); backdrop-filter:blur(12px); border-radius:18px;
      border:2px solid rgba(153,113,190,.28); box-shadow:0 20px 40px rgba(57,22,89,.28); padding:26px; color:#391659}
    .panel h2{font-size:1.25rem;margin-bottom:10px}
    .panel p{color:#7d5aa6}
    .url-example{background:rgba(57,22,89,.08); padding:10px; border-radius:10px; margin-top:14px;
      font-family:'Courier New',monospace; font-size:.86rem; color:#391659; word-break:break-all; border:1px solid rgba(153,113,190,.28)}
    iframe{width:100%; height:680px; border:none; border-radius:18px; background:#fff;
      box-shadow:0 25px 50px rgba(57,22,89,.35); border:3px solid #9971BE}
    .footer{
      text-align:center; margin-top:16px; font-size:.95rem;
      background:linear-gradient(135deg,#fff 0%,#F88809 100%);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-weight:600
    }
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img class="hero-image" alt="Akuunda Pay" src="https://raw.githubusercontent.com/David-akuundapay/mtpelerin-akuunda/main/mtpelerin-akuunda/images/brand-hero.jpg" />
      <h1>Akuunda Pay</h1>
      <p>√âchange Crypto S√©curis√©</p>
    </div>

    <div id="serviceIndicator" class="service-indicator">üîÑ Chargement du service...</div>

    <div id="errorMessage" class="panel">
      <h2>üîß Configuration requise</h2>
      <p>Param√®tres manquants dans l‚ÄôURL.</p>
      <div class="url-example">
        <strong>Exemple SELL (vente crypto ‚Üí fiat) :</strong><br />
        ?tab=sell&ssc=USDT&sdc=EUR&ssa=100&snet=matic_mainnet&net=matic_mainnet<br /><br />
        <strong>Exemple BUY (achat fiat ‚Üí crypto) :</strong><br />
        ?tab=buy&bsc=EUR&bdc=USDT&bsa=100&dnet=matic_mainnet&net=matic_mainnet&pm=card
      </div>
    </div>

    <div id="loadingMessage" class="panel hidden">
      <h2>‚è≥ Chargement‚Ä¶</h2>
      <p>Initialisation de la plateforme Akuunda Pay</p>
    </div>

    <div id="widgetContainer" class="hidden">
      <iframe id="widget" allow="usb; ethereum; clipboard-write; payment;" loading="eager" title="Akuunda Pay - Exchange Platform"></iframe>
    </div>

    <div class="footer">üí≥ Service s√©curis√© par Akuunda Pay</div>
  </div>

  <script>
    // ====== CONFIG ======
    const CONFIG = {
      BACKEND_URL: 'https://mtpay.akuunda-pay.io/api/mtpelerin',
      API_TOKEN: '1c7a15d7-7243-4a77-a04e-c2b74061fa88'
    };

    // Th√®me 100% orange (boutons)
    const BRANDING = {
      // La plupart des widgets Mt Pelerin acceptent la couleur hex sans #
      primaryColor: 'F88809',     // Boutons principaux => orange Akuunda
      primaryTextColor: 'FFFFFF', // Texte blanc sur boutons orange
      secondaryColor: 'F88809',   // Harmonis√© en orange aussi
      background: 'F8F9FA',
      successColor: 'F88809',
      warningColor: 'FF8C00',
      infoColor: 'F88809',
      lang: 'auto',
      hideNetworkSwitch: 'true',
      // IMPORTANT : afficher uniquement l‚Äôonglet s√©lectionn√©
      hideTabs: 'true'
    };

    // ====== UTILS ======
    function getParams() {
      const qs = new URLSearchParams(location.search);
      const out = {};
      for (const [k, v] of qs.entries()) out[k] = v;
      return out;
    }

    function sanitizeTab(rawTab) {
      const t = (rawTab || '').toLowerCase();
      if (t === 'buy' || t === 'sell') return t;
      return 'buy'; // d√©faut : BUY
    }

    // Affiche uniquement l‚Äôonglet demand√© et nettoie les params de l‚Äôautre onglet
    function buildWidgetUrl(params) {
      const tab = sanitizeTab(params.tab || params.type || params.tabs);

      const base = {
        _ctkn: CONFIG.API_TOKEN,
        // on force le tab + on limite visuellement via hideTabs + tabs=<tab_uniquement>
        tab,
        tabs: tab,              // <- n‚Äôaffiche que l‚Äôonglet s√©lectionn√©
        lang: params.lang || BRANDING.lang,
        hideTabs: BRANDING.hideTabs,
        hideNetworkSwitch: BRANDING.hideNetworkSwitch,
        // Th√®me orange
        primaryColor: BRANDING.primaryColor,
        primaryTextColor: BRANDING.primaryTextColor,
        secondaryColor: BRANDING.secondaryColor,
        background: BRANDING.background,
        successColor: BRANDING.successColor,
        warningColor: BRANDING.warningColor,
        infoColor: BRANDING.infoColor,
        // commun
        net: params.net || 'matic_mainnet',
        addr: params.addr || '',
        code: params.code || '',
        hash: params.hash || ''
      };

      // Ajoute UNIQUEMENT les param√®tres pertinents pour le tab choisi
      if (tab === 'sell') {
        base.ssc = params.ssc || 'USDT';
        base.sdc = params.sdc || 'EUR';
        base.ssa = params.ssa || '100';
        base.snet = params.snet || 'matic_mainnet';
        // s√©curit√© : supprime cl√©s BUY si pass√©es par erreur
        delete base.bsc; delete base.bdc; delete base.bsa; delete base.dnet; delete base.pm;
      } else {
        // BUY
        base.bsc = params.bsc || 'EUR';
        base.bdc = params.bdc || 'USDT';
        base.bsa = params.bsa || '100';
        base.dnet = params.dnet || 'matic_mainnet';
        base.pm  = params.pm  || 'card';
        // s√©curit√© : supprime cl√©s SELL si pass√©es par erreur
        delete base.ssc; delete base.sdc; delete base.ssa; delete base.snet;
      }

      // Nettoyage des champs vides
      Object.keys(base).forEach(k => { if (base[k] === '') delete base[k]; });

      const q = new URLSearchParams(base);
      return `https://widget.mtpelerin.com/?${q.toString()}`;
    }

    function requiredFor(tab) {
      return tab === 'sell' ? ['ssc','sdc'] : ['bsc','bdc'];
    }

    function updateIndicator(tab, p) {
      const el = document.getElementById('serviceIndicator');
      if (tab === 'sell') {
        const left  = p.ssc || 'USDT';
        const right = p.sdc || 'EUR';
        const amt   = p.ssa ? ` | Montant: ${p.ssa} ${left}` : '';
        el.textContent = `üí∞ VENTE : ${left} ‚Üí ${right}${amt}`;
      } else {
        const left  = p.bsc || 'EUR';
        const right = p.bdc || 'USDT';
        const amt   = p.bsa ? ` | Montant: ${p.bsa} ${left}` : '';
        el.textContent = `üí≥ ACHAT : ${left} ‚Üí ${right}${amt}`;
      }
    }

    function show(id){document.getElementById(id).classList.remove('hidden')}
    function hide(id){document.getElementById(id).classList.add('hidden')}

    function setState(state){
      // states: error | loading | loaded
      if (state === 'error') {
        show('errorMessage'); hide('loadingMessage'); hide('widgetContainer');
      } else if (state === 'loading') {
        hide('errorMessage'); show('loadingMessage'); hide('widgetContainer');
      } else {
        hide('errorMessage'); hide('loadingMessage'); show('widgetContainer');
      }
    }

    // ====== BACKEND HOOKS (optionnels) ======
    async function sendToBackend(endpoint, data){
      try{
        const r = await fetch(`${CONFIG.BACKEND_URL}/${endpoint}`,{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)
        });
        if(!r.ok) console.log(`Backend ${endpoint} non OK`);
      }catch(e){ console.log(`Backend ${endpoint} indisponible`); }
    }

    function wireWidgetEvents(){
      window.addEventListener('message',(event)=>{
        if(!event.origin.includes('mtpelerin.com')) return;
        let msg = event.data;
        try{ if(typeof msg === 'string') msg = JSON.parse(msg); }catch(e){}
        if(!msg || !msg.type) return;

        switch(msg.type){
          case 'orderCreated':    if(msg.data?.id){ sendToBackend('order/created',    { ...msg.data, ts:new Date().toISOString() }); } break;
          case 'paymentSubmitted':                 sendToBackend('payment/submitted',{ ...msg.data, ts:new Date().toISOString() }); break;
          case 'orderCompleted':                   sendToBackend('order/completed',  { ...msg.data, ts:new Date().toISOString() }); break;
          case 'orderFailed':                      sendToBackend('order/failed',     { ...msg.data, ts:new Date().toISOString() }); break;
        }
      });
    }

    // ====== INIT ======
    (function init(){
      wireWidgetEvents();

      const params = getParams();
      const tab = sanitizeTab(params.tab || params.type || params.tabs);
      const missing = requiredFor(tab).filter(k => !params[k]);

      if (missing.length){
        setState('error');
        updateIndicator(tab, params);
        return;
      }

      setState('loading');
      updateIndicator(tab, params);

      const url = buildWidgetUrl(params);
      const iframe = document.getElementById('widget');

      iframe.onload = ()=> setState('loaded');
      iframe.onerror = ()=> setState('error');
      iframe.src = url;
    })();
  </script>
</body>
</html>
