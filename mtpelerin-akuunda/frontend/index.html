<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Akuunda Pay - Exchange</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="no-referrer-when-downgrade" />
  <style>
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0b0720 url('https://raw.githubusercontent.com/David-akuundapay/mtpelerin-akuunda/main/mtpelerin-akuunda/images/brand-hero.jpg') center/cover fixed no-repeat;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:100%;max-width:520px}
    .card{background:rgba(255,255,255,.96);border-radius:18px;border:2px solid rgba(153,113,190,.25);box-shadow:0 20px 50px rgba(26,16,59,.35);padding:20px}
    h1{margin:0 0 6px;background:linear-gradient(135deg,#fff, #F88809);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{margin:0 0 14px;color:#5a3a86}
    .badge{background:#391659;color:#fff;font-weight:700;border-radius:10px;padding:10px 14px;text-align:center;margin:10px 0}
    .muted{color:#7c5aa6}
    .examples{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f6f3fb;border:1px solid #e5dbff;padding:10px;border-radius:10px;word-break:break-all}
    iframe{width:100%;height:680px;border:none;border-radius:16px;box-shadow:0 22px 44px rgba(26,16,59,.35);border:3px solid #9971BE}
    .hidden{display:none}
    .foot{margin-top:10px;text-align:center;font-weight:600;background:linear-gradient(135deg,#fff,#F88809);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Akuunda Pay</h1>
      <p class="subtitle">√âchange crypto s√©curis√©</p>

      <div id="indicator" class="badge">üîÑ Chargement‚Ä¶</div>

      <div id="panelError" class="">
        <p class="muted">Param√®tres manquants ou invalides dans l‚ÄôURL.</p>
        <div class="examples">
          <strong>SELL (crypto ‚Üí EUR) :</strong><br>
          <code>?tab=sell&ssc=USDC&sdc=EUR&ssa=125.5&net=matic_mainnet&snet=matic_mainnet</code>
          <br><br>
          <strong>BUY (EUR ‚Üí crypto) :</strong><br>
          <code>?tab=buy&bsc=EUR&bdc=USDC&bsa=125.5&net=matic_mainnet&dnet=matic_mainnet&pm=card</code>
        </div>
      </div>

      <div id="panelLoading" class="hidden">
        <p class="muted">Initialisation du widget‚Ä¶</p>
      </div>

      <div id="panelWidget" class="hidden">
        <iframe id="widget" allow="payment; clipboard-write; ethereum; usb" title="Akuunda Pay Widget"></iframe>
      </div>

      <div class="foot">üí≥ Service par Akuunda Pay</div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const CONFIG = {
      TOKEN: '1c7a15d7-7243-4a77-a04e-c2b74061fa88'
    };

    // Couleurs (versions avec et sans # pour compatibilit√©)
    const ORANGE_HEX = 'F88809';
    const ORANGE_HEX_HASH = '%23F88809'; // encod√© pour l‚ÄôURL
    const WHITE_HEX = 'FFFFFF';
    const WHITE_HEX_HASH = '%23FFFFFF';
    const BG_HEX = 'F8F9FA';

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const show = (id) => $(id).classList.remove('hidden');
    const hide = (id) => $(id).classList.add('hidden');

    function getParams(){
      const p = {}; const q = new URLSearchParams(location.search);
      for(const [k,v] of q.entries()) p[k]=v;
      return p;
    }

    function pickTab(raw){
      const v = (raw||'').toLowerCase();
      if (v === 'buy' || v === 'sell') return v;
      return null;
    }

    function needKeys(tab){
      return tab === 'sell' ? ['ssc','sdc'] : ['bsc','bdc'];
    }

    function hasRequired(params, tab){
      return needKeys(tab).every(k => params[k] && String(params[k]).trim() !== '');
    }

    // Construit une URL MtPelerin qui n‚Äôaffiche QUE l‚Äôonglet choisi
    function buildWidgetUrl(params){
      const tab = pickTab(params.tab || params.type || params.tabs) || 'buy';

      // base strict : forcer un seul onglet visible et actif
      const base = {
        _ctkn: CONFIG.TOKEN,
        tab,               // onglet actif
        tabs: tab,         // n‚Äôaffiche que cet onglet
        lang: (params.lang || 'auto'),
        // Couleurs (on passe plusieurs cl√©s pour maximiser la prise en compte c√¥t√© widget)
        primaryColor: ORANGE_HEX,
        primaryTextColor: WHITE_HEX,
        secondaryColor: ORANGE_HEX,
        background: BG_HEX,
        successColor: ORANGE_HEX,
        warningColor: ORANGE_HEX,
        infoColor: ORANGE_HEX,
        // variantes encod√©es (#) au cas o√π le widget l‚Äôexige
        primaryColorHex: ORANGE_HEX_HASH,
        primaryTextColorHex: WHITE_HEX_HASH,
        accentColor: ORANGE_HEX,       // alias possibles
        accentColorHex: ORANGE_HEX_HASH,
        // r√©seau commun
        net: params.net || 'matic_mainnet',
        addr: params.addr || '',
        code: params.code || '',
        hash: params.hash || ''
      };

      if (tab === 'sell'){
        base.ssc  = params.ssc  || 'USDC';
        base.sdc  = params.sdc  || 'EUR';
        base.ssa  = params.ssa  || '100';
        base.snet = params.snet || 'matic_mainnet';
        // purge des cl√©s BUY
        delete base.bsc; delete base.bdc; delete base.bsa; delete base.dnet; delete base.pm;
      } else {
        base.bsc  = params.bsc  || 'EUR';
        base.bdc  = params.bdc  || 'USDC';
        base.bsa  = params.bsa  || '100';
        base.dnet = params.dnet || 'matic_mainnet';
        base.pm   = params.pm   || 'card';
        // purge des cl√©s SELL
        delete base.ssc; delete base.sdc; delete base.ssa; delete base.snet;
      }

      // Nettoyage des vides
      Object.keys(base).forEach(k => { if (base[k] === '') delete base[k]; });

      const q = new URLSearchParams(base);
      return `https://widget.mtpelerin.com/?${q.toString()}`;
    }

    function updateIndicator(tab, p){
      if (tab === 'sell'){
        const from = p.ssc || 'USDC', to = p.sdc || 'EUR', amt = p.ssa ? ` | Montant: ${p.ssa} ${from}` : '';
        $('indicator').textContent = `üí∞ SELL : ${from} ‚Üí ${to}${amt}`;
      } else {
        const from = p.bsc || 'EUR', to = p.bdc || 'USDC', amt = p.bsa ? ` | Montant: ${p.bsa} ${from}` : '';
        $('indicator').textContent = `üí≥ BUY : ${from} ‚Üí ${to}${amt}`;
      }
    }

    // ===== Init =====
    (function(){
      const p = getParams();
      const tab = pickTab(p.tab || p.type || p.tabs);

      if (!tab || !hasRequired(p, tab)){
        // erreur (tab absent/invalid OU cl√©s minimales manquantes)
        show('panelError'); hide('panelLoading'); hide('panelWidget');
        $('indicator').textContent = '‚ö†Ô∏è Param√®tres requis manquants';
        return;
      }

      // ok ‚Üí charge widget
      hide('panelError'); show('panelLoading'); hide('panelWidget');
      updateIndicator(tab, p);

      const url = buildWidgetUrl(p);
      const iframe = $('widget');

      iframe.onload  = () => { hide('panelLoading'); show('panelWidget'); };
      iframe.onerror = () => { hide('panelLoading'); show('panelError'); $('indicator').textContent = '‚ùå √âchec de chargement du widget'; };

      // S√©curit√©: neutraliser tout r√©sidu d‚Äôautre onglet dans l‚ÄôURL finale
      iframe.src = url;
    })();
  </script>
</body>
</html>
